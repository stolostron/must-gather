#!/bin/bash
#set -x

BASE_COLLECTION_PATH="/must-gather"
mkdir -p ${BASE_COLLECTION_PATH}

CLUSTER="SPOKE"
HUBNAMESPACE=""
MCNAMESPACE=""

check_spokes() {
    echo "The list of spoke clusters that are configured on this Hub:" >> ${BASE_COLLECTION_PATH}/gather-spoke.log
    #These calls will change with new API
    oc get clusters --all-namespaces >> ${BASE_COLLECTION_PATH}/gather-spoke.log 
    
    #to capture details in the manahed cluster namespace to debug hive issues
    #refer https://github.com/open-cluster-management/backlog/issues/2682
    MCNAMESPACE=`oc get clusters --all-namespaces --no-headers=true -o custom-columns="NAMESPACE:.metadata.namespace"`
    for mcns in ${MCNAMESPACE[@]};
    do
        #oc kubectl get pods -n "$mcns" >> ${BASE_COLLECTION_PATH}/gather-spoke.log 
        oc adm inspect  ns/"$mcns"  --dest-dir=must-gather
    done

}

check_if_hub () {
    HUBNAMESPACE=`oc get multiclusterhubs.operators.open-cluster-management.io --all-namespaces --no-headers=true| awk '{ print $1 }'`
    echo "$HUBNAMESPACE"
     #if [[ "$NAMESPACE" != error* ]];
     #   then CLUSTER="HUB"
     #fi  
     if [[ -z "$HUBNAMESPACE" ]] ;
        then CLUSTER="SPOKE"
     else  CLUSTER="HUB"
     fi 
}


check_if_hub

echo "$CLUSTER"

case "$CLUSTER" in 
    #case 1 
    "HUB")

    check_spokes
    #oc adm inspect  ns/open-cluster-management  --dest-dir=must-gather
    oc get pods -n "$HUBNAMESPACE" > ${BASE_COLLECTION_PATH}/gather-acm.log 
    oc adm inspect  ns/"$HUBNAMESPACE"  --dest-dir=must-gather
    oc adm inspect  ns/hive  --dest-dir=must-gather
    oc adm inspect  multiclusterhubs.operators.open-cluster-management.io --all-namespaces  --dest-dir=must-gather

    oc adm inspect endpointconfigs.multicloud.ibm.com --all-namespaces  --dest-dir=must-gather
    oc adm inspect hiveconfigs.hive.openshift.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect applications.app.k8s.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect channels.apps.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect deployables.apps.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect helmreleases.apps.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect placementrules.apps.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect subscriptions.apps.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect policies.policy.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect placementbindings.policy.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect clusterdeployments.hive.openshift.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect clusterimagesets.hive.openshift.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect machinesets.machine.openshift.io --all-namespaces  --dest-dir=must-gather

    oc adm inspect  managedclusterviews.view.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect  managedclusteractions.action.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect  manifestworks.work.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect  managedclusters.cluster.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect  managedclusterinfos.internal.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect  clustermanagers.operator.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect  certificates.certmanager.k8s.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect  issuers.certmanager.k8s.io --all-namespaces  --dest-dir=must-gather

    ;;

      
    #case 2 
    "SPOKE")
    oc adm inspect klusterlets.operator.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect ns/multicluster-endpoint --dest-dir=must-gather
    oc adm inspect endpoints.multicloud.ibm.com --all-namespaces  --dest-dir=must-gather
    oc adm inspect workmanagers.multicloud.ibm.com --all-namespaces  --dest-dir=must-gather
    oc adm inspect policies.policy.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect certificatepolicies.policy.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect iampolicies.policy.open-cluster-management.io --all-namespaces  --dest-dir=must-gather
    oc adm inspect cispolicies.policy.open-cluster-management.io --all-namespaces  --dest-dir=must-gather

    
    ;; 
      
   
esac 



exit 0
